"use strict";(()=>{var e={};e.id=471,e.ids=[471],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},70612:e=>{e.exports=require("node:os")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},54219:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>k,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>q,staticGenerationAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{POST:()=>m});var i=r(49303),a=r(88716),n=r(60670),o=r(87070),u=r(53524),p=r(47291),c=r(84770),d=r.n(c),l=r(1313);let y=new u.PrismaClient,f=process.env.ENCRYPTION_KEY||"default-key-replace-in-production-32chars";async function m(e){try{let e=await (0,l.vz)();await y.user.update({where:{email:e},data:{apifyKeyStatus:"TESTING"}});let t=await y.user.findUnique({where:{email:e},select:{apifyApiKey:!0}});if(!t?.apifyApiKey)return await y.user.update({where:{email:e},data:{apifyKeyStatus:"NOT_CONFIGURED"}}),o.NextResponse.json({error:"No API key configured"},{status:400});let r=function(e){let t=d().createDecipher("aes-256-cbc",f),r=t.update(e,"hex","utf8");return r+=t.final("utf8")}(t.apifyApiKey),s=await g(r);return await y.user.update({where:{email:e},data:{apifyKeyStatus:s.isValid?"VALID":"INVALID",apifyKeyLastTested:new Date}}),o.NextResponse.json({success:!0,isValid:s.isValid,message:s.message,status:s.isValid?"VALID":"INVALID"})}catch(e){console.error("Error testing API key:",e);try{let e=await (0,l.vz)();await y.user.update({where:{email:e},data:{apifyKeyStatus:"INVALID",apifyKeyLastTested:new Date}})}catch(e){console.error("Error updating status after test failure:",e)}return o.NextResponse.json({error:"Failed to test API key",success:!1,isValid:!1,message:"Connection test failed"},{status:500})}}async function g(e){try{let t=new p.wR({token:e}),r=await t.user().get();if(r?.id)return{isValid:!0,message:`✓ Connected to Apify account: ${r.username||r.email||"Account verified"}`};return{isValid:!1,message:"✗ API key test failed - no user information returned"}}catch(e){if(console.error("API key test error:",e),e?.message?.includes("401")||e?.message?.includes("Unauthorized"))return{isValid:!1,message:"✗ Invalid API key - authentication failed"};if(e?.message?.includes("403")||e?.message?.includes("Forbidden"))return{isValid:!1,message:"✗ API key has insufficient permissions"};if(e?.message?.includes("network")||e?.message?.includes("timeout"))return{isValid:!1,message:"✗ Network error - please check your connection"};return{isValid:!1,message:`✗ Test failed: ${e?.message||"Unknown error"}`}}}let h=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/settings/apify-key/test/route",pathname:"/api/settings/apify-key/test",filename:"route",bundlePath:"app/api/settings/apify-key/test/route"},resolvedPagePath:"/home/ubuntu/ccc_healthcare_pipeline/app/app/api/settings/apify-key/test/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:x,staticGenerationAsyncStorage:w,serverHooks:q}=h,A="/api/settings/apify-key/test/route";function k(){return(0,n.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:w})}},1313:(e,t,r)=>{r.d(t,{vz:()=>i});let s=new(r(53524)).PrismaClient;async function i(){try{let e=await s.user.findFirst({select:{email:!0},orderBy:{createdAt:"asc"}});return e?.email||"john@doe.com"}catch(e){return console.error("Error fetching current user email:",e),"john@doe.com"}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,972,291],()=>r(54219));module.exports=s})();